<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="theme-color" content="#E30000"/>
<title>Colgate Smile Meter</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
  
  :root {
    --brand-red: #E30000;
    --brand-red-dark: #C20000;
    --text-light: rgba(255,255,255,0.95);
    --text-muted: rgba(255,255,255,0.7);
  }

  html, body {
    height: 100%;
    width: 100%;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: #000;
    color: white;
    overflow: hidden;
    position: fixed;
  }

  .camera-app {
    width: 100%;
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    position: relative;
    background: #000;
  }

  /* Camera Viewport - Takes most of the screen */
  .camera-viewport {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #000;
  }

  .bg-layer {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    opacity: 0;
    transition: opacity 0.6s ease;
    z-index: 1;
  }

  .bg-layer.active { opacity: 1; }

  .bg-smiles { background-image: url('static/assets/bg_smiles.png'); }
  .bg-waves { background-image: url('static/assets/bg_waves.png'); }
  .bg-products { background-image: url('static/assets/bg_products.png'); }

  .face-frame {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 260px;
    height: 320px;
    border-radius: 130px 130px 160px 160px;
    overflow: hidden;
    z-index: 10;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.9), 0 0 0 6px rgba(227,0,0,0.3);
    animation: pulse-frame 2s ease-in-out infinite;
  }

  @keyframes pulse-frame {
    0%, 100% { box-shadow: 0 0 0 3px rgba(255,255,255,0.9), 0 0 0 6px rgba(227,0,0,0.3); }
    50% { box-shadow: 0 0 0 3px rgba(255,255,255,0.9), 0 0 0 6px rgba(227,0,0,0.6); }
  }

  .face-frame video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: filter 0.3s ease;
  }

  /* CSS Filters */
  .filter-warm_glow { filter: saturate(1.5) contrast(1.25) brightness(1.05) hue-rotate(-5deg); }
  .filter-vibrant { filter: saturate(1.7) brightness(1.15) contrast(1.2); }
  .filter-clarendon { filter: brightness(1.2) contrast(1.4) saturate(1.3); }
  .filter-natural_bright { filter: brightness(1.25) saturate(1.2) contrast(1.15); }
  .filter-fresh { filter: brightness(1.18) saturate(1.3) hue-rotate(5deg); }
  .filter-confident { filter: contrast(1.5) saturate(1.5); }

  /* Top Header - Compact */
  .top-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: max(env(safe-area-inset-top), 12px) 16px 12px;
    background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo-text {
    font-size: 18px;
    font-weight: 800;
    color: white;
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
  }

  .stats-mini {
    display: flex;
    gap: 12px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
  }

  .stats-mini span {
    background: rgba(0,0,0,0.3);
    padding: 4px 10px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
  }

  /* Guide Text */
  .guide-text {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(10px);
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    z-index: 20;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  /* Bottom Controls - Compact and Fixed */
  .bottom-controls {
    position: relative;
    background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, #000 100%);
    padding: 16px 16px max(env(safe-area-inset-bottom), 16px);
    z-index: 30;
  }

  /* Smile Meter - Horizontal Loading Bar */
  .smile-meter {
    margin-bottom: 16px;
  }

  .meter-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .meter-label {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-light);
  }

  .meter-score {
    font-size: 20px;
    font-weight: 900;
    color: var(--brand-red);
  }

  .meter-bar-container {
    height: 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 20px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  }

  .meter-bar-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #ff6666 0%, #ff3333 50%, var(--brand-red) 100%);
    border-radius: 20px;
    transition: width 0.3s ease-out;
    position: relative;
    box-shadow: 0 0 10px rgba(227,0,0,0.5);
  }

  .meter-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 40px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  /* Options Row - Horizontal Scroll */
  .options-row {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding: 2px;
  }

  .options-row::-webkit-scrollbar { display: none; }

  .option-chip {
    flex-shrink: 0;
    background: rgba(255,255,255,0.1);
    border: 2px solid transparent;
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.2s;
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .option-chip.active {
    background: var(--brand-red);
    border-color: var(--brand-red);
    color: white;
    box-shadow: 0 0 0 2px rgba(227,0,0,0.3);
  }

  .option-chip:active {
    transform: scale(0.95);
  }

  /* Capture Button */
  .capture-section {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
  }

  .capture-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: white;
    border: 5px solid var(--brand-red);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    box-shadow: 0 4px 20px rgba(227,0,0,0.4);
  }

  .capture-btn:active {
    transform: scale(0.9);
  }

  .capture-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .capture-btn::before {
    content: '';
    position: absolute;
    inset: 8px;
    border-radius: 50%;
    background: var(--brand-red);
    transition: all 0.2s;
  }

  .capture-btn:not(:disabled):active::before {
    background: var(--brand-red-dark);
    transform: scale(0.8);
  }

  .capture-label {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-light);
    text-align: center;
  }

  .capture-hint {
    font-size: 11px;
    color: var(--text-muted);
  }

  /* Success Toast */
  .toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: rgba(16, 185, 129, 0.95);
    backdrop-filter: blur(10px);
    color: white;
    padding: 20px 30px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .toast.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }

  /* Loading State */
  .loading-ring {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Small screens */
  @media (max-height: 700px) {
    .face-frame { width: 220px; height: 280px; }
    .bottom-controls { padding: 12px 16px max(env(safe-area-inset-bottom), 12px); }
    .smile-meter { margin-bottom: 12px; }
    .options-row { margin-bottom: 12px; }
  }

  /* Very small screens */
  @media (max-height: 600px) {
    .face-frame { width: 200px; height: 260px; }
    .capture-btn { width: 60px; height: 60px; border-width: 4px; }
    .meter-bar-container { height: 10px; }
  }
</style>
</head>
<body>
  <div class="camera-app">
    <!-- Camera Viewport -->
    <div class="camera-viewport">
      <!-- Background Layers -->
      <div class="bg-layer bg-smiles active" id="bgSmiles"></div>
      <div class="bg-layer bg-waves" id="bgWaves"></div>
      <div class="bg-layer bg-products" id="bgProducts"></div>

      <!-- Face Frame with Video -->
      <div class="face-frame">
        <video id="video" autoplay playsinline muted></video>
      </div>

      <!-- Top Header -->
      <div class="top-header">
        <div class="logo-text">Colgate ‚ú®</div>
        <div class="stats-mini">
          <span>üì∏ <span id="attempts">0</span></span>
          <span>üèÜ <span id="bestScore">0</span></span>
        </div>
      </div>

      <!-- Guide Text -->
      <div class="guide-text" id="guideText">üë§ Position your face</div>
    </div>

    <!-- Bottom Controls -->
    <div class="bottom-controls">
      <!-- Smile Meter -->
      <div class="smile-meter">
        <div class="meter-header">
          <span class="meter-label">üòä Smile Strength</span>
          <span class="meter-score" id="scoreNumber">0%</span>
        </div>
        <div class="meter-bar-container">
          <div class="meter-bar-fill" id="meterBar"></div>
        </div>
      </div>

      <!-- Background Options -->
      <div class="options-row" id="bgOptions">
        <button class="option-chip active" data-bg="smiles">üé® Smiles</button>
        <button class="option-chip" data-bg="waves">üåä Fresh</button>
        <button class="option-chip" data-bg="products">üì¶ Products</button>
      </div>

      <!-- Filter Options -->
      <div class="options-row" id="filterOptions">
        <button class="option-chip active" data-filter="none">üì∑ Original</button>
        <button class="option-chip" data-filter="warm_glow">‚òÄÔ∏è Warm</button>
        <button class="option-chip" data-filter="vibrant">üåü Vibrant</button>
        <button class="option-chip" data-filter="clarendon">‚ú® Bright</button>
        <button class="option-chip" data-filter="natural_bright">üå§Ô∏è Natural</button>
        <button class="option-chip" data-filter="fresh">üíö Fresh</button>
        <button class="option-chip" data-filter="confident">üí™ Bold</button>
      </div>

      <!-- Capture Button -->
      <div class="capture-section">
        <button class="capture-btn" id="captureBtn" disabled></button>
      </div>
    </div>

    <!-- Success Toast -->
    <div class="toast" id="toast">‚úì Photo captured!</div>
  </div>

  <script>
    // State
    let analyzing = false;
    let canCapture = false;
    let selectedFilter = 'none';
    let selectedBackground = 'smiles';
    let isCapturing = false;

    // Elements
    const video = document.getElementById('video');
    const captureBtn = document.getElementById('captureBtn');
    const scoreNumber = document.getElementById('scoreNumber');
    const meterBar = document.getElementById('meterBar');
    const guideText = document.getElementById('guideText');
    const attempts = document.getElementById('attempts');
    const bestScore = document.getElementById('bestScore');
    const toast = document.getElementById('toast');

    // Initialize camera
    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 1280 },
            facingMode: 'user'
          },
          audio: false
        });
        video.srcObject = stream;
        await new Promise(resolve => video.onloadedmetadata = resolve);
        await video.play();
        console.log('‚úì Camera initialized');
        startAnalysis();
        fetchStats();
      } catch (error) {
        console.error('Camera error:', error);
        guideText.textContent = '‚ö†Ô∏è Enable camera access';
      }
    }

    // Capture frame as data URL
    function captureFrame() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');

      // Apply filter
      const filters = {
        none: 'none',
        warm_glow: 'saturate(1.5) contrast(1.25) brightness(1.05) hue-rotate(-5deg)',
        vibrant: 'saturate(1.7) brightness(1.15) contrast(1.2)',
        clarendon: 'brightness(1.2) contrast(1.4) saturate(1.3)',
        natural_bright: 'brightness(1.25) saturate(1.2) contrast(1.15)',
        fresh: 'brightness(1.18) saturate(1.3) hue-rotate(5deg)',
        confident: 'contrast(1.5) saturate(1.5)'
      };

      ctx.filter = filters[selectedFilter] || 'none';
      ctx.drawImage(video, 0, 0);
      ctx.filter = 'none';

      return canvas.toDataURL('image/jpeg', 0.95);
    }

    // Analyze frame
    async function analyzeFrame() {
      if (analyzing || isCapturing) return;
      analyzing = true;

      const dataUrl = captureFrame();
      if (!dataUrl) {
        analyzing = false;
        return;
      }

      try {
        const response = await fetch('/analyze-frame', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: dataUrl })
        });

        const data = await response.json();

        if (data.error) {
          guideText.textContent = '‚ö†Ô∏è ' + data.error;
        } else {
          const score = data.smile_score || 0;
          
          // Update score and meter
          scoreNumber.textContent = score + '%';
          meterBar.style.width = score + '%';

          // Update guide
          if (data.quality_checks) {
            if (!data.quality_checks.face_detected) {
              guideText.textContent = 'üë§ Position your face';
            } else if (!data.quality_checks.centered) {
              guideText.textContent = '‚ÜîÔ∏è Center your face';
            } else if (!data.quality_checks.head_straight) {
              guideText.textContent = 'üìè Keep head straight';
            } else if (score < 60) {
              guideText.textContent = 'üòä Smile wider!';
            } else {
              guideText.textContent = '‚ú® Perfect! Tap to capture';
            }
          }

          // Update button
          canCapture = data.can_capture || false;
          captureBtn.disabled = !canCapture;

          fetchStats();
        }
      } catch (error) {
        console.error('Analysis error:', error);
      }

      analyzing = false;
    }

    // Start analysis loop
    function startAnalysis() {
      setInterval(analyzeFrame, 500);
    }

    // Background selection
    document.getElementById('bgOptions').addEventListener('click', (e) => {
      const chip = e.target.closest('.option-chip');
      if (!chip) return;

      document.querySelectorAll('#bgOptions .option-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');

      selectedBackground = chip.dataset.bg;

      document.querySelectorAll('.bg-layer').forEach(layer => layer.classList.remove('active'));
      document.getElementById(`bg${chip.dataset.bg.charAt(0).toUpperCase() + chip.dataset.bg.slice(1)}`).classList.add('active');
    });

    // Filter selection
    document.getElementById('filterOptions').addEventListener('click', (e) => {
      const chip = e.target.closest('.option-chip');
      if (!chip) return;

      document.querySelectorAll('#filterOptions .option-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');

      selectedFilter = chip.dataset.filter;

      // Apply filter to video
      video.className = '';
      if (selectedFilter !== 'none') {
        video.classList.add('filter-' + selectedFilter);
      }
    });

    // Capture photo
    captureBtn.addEventListener('click', async () => {
      if (isCapturing) return;
      
      isCapturing = true;
      captureBtn.disabled = true;

      const dataUrl = captureFrame();

      try {
        const response = await fetch('/capture-photo', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            image: dataUrl,
            filter: selectedFilter,
            background: selectedBackground
          })
        });

        const data = await response.json();

        if (data.success) {
          // Download photo
          const a = document.createElement('a');
          a.href = `/download/${data.photo_id}`;
          a.download = `colgate_${data.photo_id}.jpg`;
          document.body.appendChild(a);
          a.click();
          a.remove();

          // Show success toast
          toast.textContent = `‚úì Captured! Score: ${data.smile_score}%`;
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 2500);

          fetchStats();
        } else {
          alert(data.error || 'Capture failed');
        }
      } catch (error) {
        console.error('Capture error:', error);
        alert('Error capturing photo');
      } finally {
        isCapturing = false;
        setTimeout(() => {
          captureBtn.disabled = !canCapture;
        }, 1000);
      }
    });

    // Fetch stats
    async function fetchStats() {
      try {
        const response = await fetch('/stats', { credentials: 'include' });
        const data = await response.json();
        attempts.textContent = data.attempts || 0;
        bestScore.textContent = data.highest_score || 0;
      } catch (error) {
        console.error('Stats error:', error);
      }
    }

    // Initialize on load
    window.addEventListener('load', initCamera);
  </script>
</body>
</html>